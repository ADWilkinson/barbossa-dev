<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barbossa Control Center</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
            color: #e0e0e0;
            min-height: 100vh;
        }
        
        .header {
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-bottom: 2px solid #00ffcc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            color: #00ffcc;
            font-size: 28px;
            display: flex;
            align-items: center;
        }
        
        .header .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-online { background: #00ff88; color: #000; }
        .status-offline { background: #ff4444; color: #fff; }
        .status-working { background: #ffaa00; color: #000; }
        
        .container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            padding: 20px;
        }
        
        .card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }
        
        .card h2 {
            color: #00ffcc;
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 10px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .stat-box {
            background: rgba(0,255,204,0.1);
            border: 1px solid #00ffcc;
            border-radius: 5px;
            padding: 10px;
            text-align: center;
        }
        
        .stat-box .value {
            font-size: 24px;
            font-weight: bold;
            color: #00ffcc;
        }
        
        .stat-box .label {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
        
        .log-viewer {
            background: #000;
            border: 1px solid #333;
            border-radius: 5px;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            font-size: 12px;
            font-family: monospace;
        }
        
        .log-entry {
            padding: 2px 0;
            border-bottom: 1px solid #111;
        }
        
        .log-entry.error { color: #ff6666; }
        .log-entry.warning { color: #ffaa00; }
        .log-entry.info { color: #00aaff; }
        .log-entry.success { color: #00ff88; }
        
        .button {
            background: #00ffcc;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
            transition: all 0.3s;
        }
        
        .button:hover {
            background: #00ff88;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,255,204,0.3);
        }
        
        .button.danger {
            background: #ff4444;
            color: #fff;
        }
        
        .button.danger:hover {
            background: #ff6666;
        }
        
        .button.secondary {
            background: #444;
            color: #fff;
        }
        
        .button.secondary:hover {
            background: #555;
        }
        
        .process-list {
            list-style: none;
        }
        
        .process-item {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 5px;
            padding: 10px;
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .process-info {
            flex: 1;
        }
        
        .process-pid {
            color: #00ffcc;
            font-weight: bold;
        }
        
        .work-tally {
            display: flex;
            justify-content: space-around;
            margin: 15px 0;
        }
        
        .work-area {
            text-align: center;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 5px;
            flex: 1;
            margin: 0 5px;
        }
        
        .work-area .count {
            font-size: 20px;
            font-weight: bold;
            color: #00ffcc;
        }
        
        .work-area .name {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 15px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: rgba(255,255,255,0.05);
            border: none;
            color: #888;
            transition: all 0.3s;
        }
        
        .tab:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .tab.active {
            background: rgba(0,255,204,0.2);
            color: #00ffcc;
            border-bottom: 2px solid #00ffcc;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .search-box {
            width: 100%;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 5px;
            color: #fff;
            margin-bottom: 10px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
        }
        
        .modal-content {
            position: relative;
            background: #1a1f3a;
            margin: 50px auto;
            padding: 20px;
            width: 80%;
            max-width: 800px;
            border-radius: 10px;
            border: 1px solid #00ffcc;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-close {
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 30px;
            color: #fff;
            cursor: pointer;
        }
        
        .modal-close:hover {
            color: #00ffcc;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,255,204,0.3);
            border-radius: 50%;
            border-top-color: #00ffcc;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>‚öì Barbossa Control Center</h1>
        <div>
            <span id="system-time">{{ timestamp }}</span>
            <span class="status-badge status-online" id="portal-status">Portal Online</span>
            <span style="margin-left: 10px;">User: {{ username }}</span>
        </div>
    </div>
    
    <div class="container">
        <!-- Barbossa Status Card -->
        <div class="card">
            <h2>üè¥‚Äç‚ò†Ô∏è Barbossa Status</h2>
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="value" id="barbossa-status">-</div>
                    <div class="label">Status</div>
                </div>
                <div class="stat-box">
                    <div class="value" id="next-run">-</div>
                    <div class="label">Next Run</div>
                </div>
                <div class="stat-box">
                    <div class="value" id="claude-count">0</div>
                    <div class="label">Claude Active</div>
                </div>
            </div>
            <div class="work-tally" id="work-tally">
                <!-- Populated by JS -->
            </div>
            <div style="text-align: center; margin-top: 15px;">
                <button class="button" onclick="triggerBarbossa()">üöÄ Trigger Manual Run</button>
                <button class="button secondary" onclick="refreshStatus()">üîÑ Refresh</button>
            </div>
        </div>
        
        <!-- System Health Card -->
        <div class="card">
            <h2>üíª System Health</h2>
            <div id="system-stats">
                <div style="margin: 10px 0;">
                    <strong>CPU:</strong> <span id="cpu-usage">Loading...</span>
                </div>
                <div style="margin: 10px 0;">
                    <strong>Memory:</strong> <span id="memory-usage">Loading...</span>
                </div>
                <div style="margin: 10px 0;">
                    <strong>Disk:</strong> <span id="disk-usage">Loading...</span>
                </div>
            </div>
            <h3 style="margin-top: 20px; color: #00ffcc;">Services</h3>
            <div id="services-list" style="margin-top: 10px;">
                <!-- Populated by JS -->
            </div>
        </div>
        
        <!-- Claude Processes Card -->
        <div class="card">
            <h2>ü§ñ Claude Processes</h2>
            <ul class="process-list" id="claude-processes">
                <!-- Populated by JS -->
            </ul>
        </div>
        
        <!-- Work History Card -->
        <div class="card">
            <h2>üìú Work History</h2>
            <div class="tabs">
                <button class="tab active" onclick="switchTab('changelogs')">Changelogs</button>
                <button class="tab" onclick="switchTab('claude-outputs')">Claude Outputs</button>
                <button class="tab" onclick="switchTab('security')">Security</button>
            </div>
            
            <div id="changelogs" class="tab-content active">
                <div id="changelog-list" class="log-viewer">
                    <!-- Populated by JS -->
                </div>
            </div>
            
            <div id="claude-outputs" class="tab-content">
                <div id="claude-output-list" class="log-viewer">
                    <!-- Populated by JS -->
                </div>
            </div>
            
            <div id="security" class="tab-content">
                <div id="security-list" class="log-viewer">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
        
        <!-- Log Management Card -->
        <div class="card">
            <h2>üóÑÔ∏è Log Management</h2>
            <input type="text" class="search-box" id="log-search" placeholder="Search logs..." onkeyup="searchLogs()">
            <div id="recent-logs" class="log-viewer" style="height: 200px;">
                <!-- Populated by JS -->
            </div>
            <div style="margin-top: 15px;">
                <button class="button secondary" onclick="showArchiveDialog()">üì¶ Archive Old Logs</button>
                <button class="button danger" onclick="clearLogs(30)">üóëÔ∏è Clear 30+ Day Logs</button>
            </div>
        </div>
        
        <!-- Quick Actions Card -->
        <div class="card">
            <h2>‚ö° Quick Actions</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button class="button" onclick="triggerBarbossa('infrastructure')">üîß Run Infrastructure</button>
                <button class="button" onclick="triggerBarbossa('personal_projects')">üíª Run Personal Projects</button>
                <button class="button" onclick="triggerBarbossa('davy_jones')">üè¥‚Äç‚ò†Ô∏è Run Davy Jones</button>
                <button class="button secondary" onclick="viewFullLogs()">üìã View Full Logs</button>
            </div>
        </div>
    </div>
    
    <!-- Log Viewer Modal -->
    <div id="logModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <h2 id="modal-title">Log Viewer</h2>
            <pre id="modal-content" style="background: #000; padding: 15px; border-radius: 5px; color: #0f0; font-size: 12px; overflow: auto; max-height: 60vh;">
                Loading...
            </pre>
        </div>
    </div>
    
    <script>
        let currentData = {};
        
        async function fetchData() {
            try {
                const [status, changelogs, security, claude, services] = await Promise.all([
                    fetch('/api/status').then(r => r.json()),
                    fetch('/api/changelogs').then(r => r.json()),
                    fetch('/api/security').then(r => r.json()),
                    fetch('/api/claude').then(r => r.json()),
                    fetch('/api/services').then(r => r.json())
                ]);
                
                currentData = { status, changelogs, security, claude, services };
                updateUI();
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }
        
        function updateUI() {
            // Update Barbossa status
            const barbossa = currentData.status?.barbossa;
            if (barbossa) {
                document.getElementById('barbossa-status').textContent = barbossa.running ? 'üü¢ Running' : '‚ö´ Idle';
                document.getElementById('next-run').textContent = barbossa.next_run || '-';
                document.getElementById('claude-count').textContent = barbossa.claude_processes?.length || 0;
                
                // Update work tally
                const tallyDiv = document.getElementById('work-tally');
                tallyDiv.innerHTML = '';
                for (const [area, count] of Object.entries(barbossa.work_tally || {})) {
                    tallyDiv.innerHTML += `
                        <div class="work-area">
                            <div class="count">${count}</div>
                            <div class="name">${area.replace('_', ' ')}</div>
                        </div>
                    `;
                }
                
                // Update Claude processes
                const claudeList = document.getElementById('claude-processes');
                claudeList.innerHTML = '';
                for (const proc of barbossa.claude_processes || []) {
                    claudeList.innerHTML += `
                        <li class="process-item">
                            <div class="process-info">
                                <span class="process-pid">PID: ${proc.pid}</span>
                                <span> | CPU: ${proc.cpu}% | MEM: ${proc.mem}%</span>
                                <span> | Started: ${proc.started}</span>
                            </div>
                            <button class="button danger" onclick="killClaude(${proc.pid})">Kill</button>
                        </li>
                    `;
                }
            }
            
            // Update system stats
            const system = currentData.status?.system;
            if (system) {
                document.getElementById('cpu-usage').textContent = system.cpu_usage || 'N/A';
                document.getElementById('memory-usage').textContent = 
                    `${system.memory?.used || '?'} / ${system.memory?.total || '?'}`;
                document.getElementById('disk-usage').textContent = 
                    `${system.disk?.used || '?'} / ${system.disk?.total || '?'} (${system.disk?.percent || '?'})`;
            }
            
            // Update services
            const servicesList = document.getElementById('services-list');
            servicesList.innerHTML = '';
            if (currentData.services) {
                for (const [service, status] of Object.entries(currentData.services)) {
                    if (service !== 'docker' && service !== 'tmux_sessions') {
                        const statusClass = status === 'active' ? 'success' : 'error';
                        servicesList.innerHTML += `
                            <div style="margin: 5px 0;">
                                <span class="log-entry ${statusClass}">‚óè ${service}: ${status}</span>
                            </div>
                        `;
                    }
                }
            }
            
            // Update changelogs
            const changelogList = document.getElementById('changelog-list');
            changelogList.innerHTML = '';
            for (const log of currentData.changelogs || []) {
                changelogList.innerHTML += `
                    <div class="log-entry" onclick="viewLog('${log.filename}')">
                        <strong>${log.work_area}</strong> - ${log.timestamp} (${log.size})
                        <div style="color: #666; font-size: 11px;">${log.summary.substring(0, 100)}...</div>
                    </div>
                `;
            }
            
            // Update Claude outputs
            const claudeOutputList = document.getElementById('claude-output-list');
            claudeOutputList.innerHTML = '';
            for (const output of currentData.claude || []) {
                const statusClass = output.status === 'completed' ? 'success' : 
                                   output.status === 'in_progress' ? 'warning' : 'error';
                claudeOutputList.innerHTML += `
                    <div class="log-entry ${statusClass}" onclick="viewLog('${output.filename}')">
                        <strong>${output.work_type}</strong> - ${output.timestamp}
                        <span> | Status: ${output.status} | Size: ${output.size}</span>
                    </div>
                `;
            }
            
            // Update security events
            const securityList = document.getElementById('security-list');
            securityList.innerHTML = '';
            for (const event of currentData.security || []) {
                const levelClass = event.level === 'ERROR' ? 'error' : 
                                  event.level === 'WARNING' ? 'warning' : 'info';
                securityList.innerHTML += `
                    <div class="log-entry ${levelClass}">
                        <strong>${event.timestamp}</strong> [${event.level}]
                        <div>${event.message}</div>
                    </div>
                `;
            }
            
            // Update recent logs
            const recentLogs = document.getElementById('recent-logs');
            recentLogs.innerHTML = '';
            for (const log of barbossa?.recent_logs || []) {
                recentLogs.innerHTML += `
                    <div class="log-entry" onclick="viewLog('${log.name}')">
                        <strong>${log.name}</strong> - ${log.modified} (${log.size})
                    </div>
                `;
            }
        }
        
        async function triggerBarbossa(area) {
            const data = area ? { work_area: area } : {};
            try {
                const response = await fetch('/api/trigger-barbossa', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (result.success) {
                    alert(`‚úÖ ${result.message}`);
                    setTimeout(fetchData, 2000);
                } else {
                    alert(`‚ùå Error: ${result.error}`);
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }
        
        async function killClaude(pid) {
            if (!confirm(`Kill Claude process ${pid}?`)) return;
            
            try {
                const response = await fetch('/api/kill-claude', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pid })
                });
                const result = await response.json();
                alert(result.success ? `‚úÖ ${result.message}` : `‚ùå ${result.error}`);
                fetchData();
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }
        
        async function clearLogs(days) {
            if (!confirm(`Archive and clear logs older than ${days} days?`)) return;
            
            try {
                const response = await fetch('/api/clear-logs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ older_than_days: days })
                });
                const result = await response.json();
                alert(`‚úÖ Archived ${result.archived_count} files to ${result.archive_location}`);
                fetchData();
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }
        
        async function viewLog(filename) {
            document.getElementById('logModal').style.display = 'block';
            document.getElementById('modal-title').textContent = `Log: ${filename}`;
            document.getElementById('modal-content').textContent = 'Loading...';
            
            try {
                const response = await fetch(`/api/log/${filename}`);
                const data = await response.json();
                document.getElementById('modal-content').textContent = data.content || data.error;
            } catch (error) {
                document.getElementById('modal-content').textContent = `Error: ${error.message}`;
            }
        }
        
        function closeModal() {
            document.getElementById('logModal').style.display = 'none';
        }
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }
        
        function refreshStatus() {
            fetchData();
        }
        
        function searchLogs() {
            const search = document.getElementById('log-search').value.toLowerCase();
            const entries = document.querySelectorAll('#recent-logs .log-entry');
            entries.forEach(entry => {
                const text = entry.textContent.toLowerCase();
                entry.style.display = text.includes(search) ? 'block' : 'none';
            });
        }
        
        function showArchiveDialog() {
            const days = prompt('Archive logs older than how many days?', '7');
            if (days && !isNaN(days)) {
                clearLogs(parseInt(days));
            }
        }
        
        function viewFullLogs() {
            // Create a comprehensive log viewer modal
            const modal = document.getElementById('logModal');
            modal.style.display = 'block';
            document.getElementById('modal-title').textContent = 'Full Log Viewer';
            
            let logContent = '<div style="padding: 10px;">';
            logContent += '<h3>Select a log to view:</h3>';
            logContent += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0;">';
            
            // Add Barbossa logs
            logContent += '<div><strong>üìù Barbossa Logs:</strong><br>';
            for (const log of currentData.status?.barbossa?.recent_logs || []) {
                logContent += `<a href="#" onclick="viewLog('${log.name}'); return false;" style="color: #00ffcc;">‚Ä¢ ${log.name}</a><br>`;
            }
            logContent += '</div>';
            
            // Add Claude outputs
            logContent += '<div><strong>ü§ñ Claude Outputs:</strong><br>';
            for (const output of currentData.claude || []) {
                logContent += `<a href="#" onclick="viewLog('${output.filename}'); return false;" style="color: #00ffcc;">‚Ä¢ ${output.filename}</a><br>`;
            }
            logContent += '</div>';
            
            // Add Changelogs
            logContent += '<div><strong>üìú Recent Changelogs:</strong><br>';
            for (const log of currentData.changelogs?.slice(0, 10) || []) {
                logContent += `<a href="#" onclick="viewLog('${log.filename}'); return false;" style="color: #00ffcc;">‚Ä¢ ${log.filename}</a><br>`;
            }
            logContent += '</div>';
            
            // Add Security logs
            logContent += '<div><strong>üîí Security Logs:</strong><br>';
            logContent += `<a href="#" onclick="viewLog('audit.log'); return false;" style="color: #00ffcc;">‚Ä¢ audit.log</a><br>`;
            logContent += `<a href="#" onclick="viewLog('security_violations.log'); return false;" style="color: #00ffcc;">‚Ä¢ security_violations.log</a><br>`;
            logContent += '</div>';
            
            logContent += '</div>';
            logContent += '<div style="margin-top: 20px; text-align: center;">';
            logContent += '<button class="button secondary" onclick="fetchData(); viewFullLogs();">üîÑ Refresh List</button>';
            logContent += '</div>';
            logContent += '</div>';
            
            document.getElementById('modal-content').innerHTML = logContent;
        }
        
        // Update time
        setInterval(() => {
            const now = new Date();
            document.getElementById('system-time').textContent = 
                now.toISOString().replace('T', ' ').substring(0, 19) + ' UTC';
        }, 1000);
        
        // Initial load and auto-refresh
        fetchData();
        setInterval(fetchData, 30000); // Refresh every 30 seconds
        
        // Close modal on click outside
        window.onclick = function(event) {
            const modal = document.getElementById('logModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>