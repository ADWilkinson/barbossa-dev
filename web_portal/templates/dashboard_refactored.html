<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barbossa Dashboard - Live Control Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: #0a0a0a;
            color: #00ff00;
            font-family: 'Courier New', monospace;
        }
        .terminal-green { color: #00ff00; }
        .terminal-yellow { color: #ffff00; }
        .terminal-red { color: #ff0000; }
        .terminal-dim { color: #008800; }
        .card {
            background: rgba(0, 255, 0, 0.05);
            border: 1px solid rgba(0, 255, 0, 0.3);
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-radius: 0.25rem;
        }
        .card-compact {
            padding: 1rem;
        }
        .btn {
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid #00ff00;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 0.25rem;
        }
        .btn:hover {
            background: rgba(0, 255, 0, 0.2);
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }
        .btn-danger {
            border-color: #ff0000;
            color: #ff0000;
        }
        .btn-danger:hover {
            background: rgba(255, 0, 0, 0.2);
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
        }
        .status-online { color: #00ff00; }
        .status-offline { color: #ff0000; }
        .status-idle { color: #ffff00; }
        .log-entry {
            padding: 0.25rem 0.5rem;
            border-left: 2px solid transparent;
            transition: all 0.2s;
            cursor: pointer;
        }
        .log-entry:hover {
            background: rgba(0, 255, 0, 0.1);
            border-left-color: #00ff00;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
        }
        .modal-content {
            background-color: #0a0a0a;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #00ff00;
            width: 90%;
            max-width: 1200px;
            max-height: 80vh;
            overflow-y: auto;
            border-radius: 0.25rem;
        }
        .close {
            color: #00ff00;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: #ff0000;
        }
        pre {
            background: #000;
            padding: 1rem;
            overflow-x: auto;
            border: 1px solid #00ff00;
            border-radius: 0.25rem;
        }
        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .scrollable-content {
            max-height: 300px;
            overflow-y: auto;
            padding-right: 0.5rem;
        }
        .scrollable-content::-webkit-scrollbar {
            width: 8px;
        }
        .scrollable-content::-webkit-scrollbar-track {
            background: rgba(0, 255, 0, 0.1);
        }
        .scrollable-content::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 0, 0.3);
            border-radius: 4px;
        }
        .scrollable-content::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 255, 0, 0.5);
        }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-4 max-w-7xl">
        <!-- Header -->
        <header class="mb-6 card">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-4xl font-bold mb-2 terminal-green">BARBOSSA CONTROL CENTER</h1>
                    <span id="system-status" class="text-lg">Initializing systems...</span>
                </div>
                <div class="text-right">
                    <div id="current-time" class="text-2xl terminal-yellow mb-2"></div>
                    <button onclick="refreshData()" class="btn">‚ü≥ Refresh All</button>
                </div>
            </div>
        </header>

        <!-- Critical Status Row - Full Width -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
            <!-- Barbossa Main Status -->
            <div class="card">
                <h2 class="text-xl font-bold mb-3 terminal-green">üö¢ BARBOSSA STATUS</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <div class="terminal-dim text-sm">Status</div>
                        <div id="barbossa-status" class="metric-value">--</div>
                    </div>
                    <div>
                        <div class="terminal-dim text-sm">Claude Processes</div>
                        <div id="claude-count" class="metric-value">0</div>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="terminal-dim text-sm">Last Run</div>
                    <div id="last-run" class="text-sm terminal-yellow">--</div>
                </div>
                <div class="mt-4 grid grid-cols-2 gap-2">
                    <button onclick="triggerBarbossa('infrastructure')" class="btn text-sm">
                        üîß Infrastructure
                    </button>
                    <button onclick="triggerBarbossa('personal_projects')" class="btn text-sm">
                        üì¶ Personal Projects
                    </button>
                    <button onclick="triggerBarbossa('davy_jones')" class="btn text-sm">
                        ‚öì Davy Jones
                    </button>
                    <button onclick="viewLogs()" class="btn text-sm">
                        üìú View Logs
                    </button>
                </div>
            </div>

            <!-- System Resources -->
            <div class="card">
                <h2 class="text-xl font-bold mb-3 terminal-green">üíª SYSTEM RESOURCES</h2>
                <div class="grid grid-cols-3 gap-2">
                    <div class="text-center">
                        <div class="terminal-dim text-xs">CPU</div>
                        <div id="cpu-usage" class="metric-value">--</div>
                    </div>
                    <div class="text-center">
                        <div class="terminal-dim text-xs">Memory</div>
                        <div id="memory-usage" class="metric-value">--</div>
                    </div>
                    <div class="text-center">
                        <div class="terminal-dim text-xs">Disk</div>
                        <div id="disk-usage" class="metric-value">--</div>
                    </div>
                </div>
                <div class="mt-3 pt-3 border-t border-green-900">
                    <div class="flex justify-between text-sm">
                        <span class="terminal-dim">Uptime:</span>
                        <span id="uptime" class="terminal-yellow">--</span>
                    </div>
                    <div class="flex justify-between text-sm mt-1">
                        <span class="terminal-dim">Network:</span>
                        <span id="network-conn" class="terminal-green">--</span>
                    </div>
                </div>
            </div>

            <!-- Work Tally -->
            <div class="card">
                <h2 class="text-xl font-bold mb-3 terminal-green">üìä WORK DISTRIBUTION</h2>
                <div id="work-tally" class="space-y-2"></div>
                <div class="mt-3 pt-3 border-t border-green-900">
                    <div class="text-sm terminal-dim">Next scheduled runs:</div>
                    <div id="next-runs" class="text-xs space-y-1 mt-2"></div>
                </div>
            </div>
        </div>

        <!-- Main Activity Section - Full Width -->
        <div class="card mb-6">
            <h2 class="text-2xl font-bold mb-4 terminal-green">üìã BARBOSSA EXECUTIONS & ACTIVITY</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                    <h3 class="font-bold mb-2 terminal-yellow">Recent Executions</h3>
                    <div id="barbossa-executions" class="scrollable-content space-y-2">
                        <div class="terminal-dim">Loading execution history...</div>
                    </div>
                </div>
                <div>
                    <h3 class="font-bold mb-2 terminal-yellow">Claude Work Summary</h3>
                    <div class="grid grid-cols-3 gap-4 mb-4">
                        <div class="text-center card-compact">
                            <div id="claude-personal" class="text-3xl font-bold terminal-yellow">0</div>
                            <div class="text-xs terminal-dim">Personal</div>
                        </div>
                        <div class="text-center card-compact">
                            <div id="claude-infrastructure" class="text-3xl font-bold terminal-green">0</div>
                            <div class="text-xs terminal-dim">Infrastructure</div>
                        </div>
                        <div class="text-center card-compact">
                            <div id="claude-davy" class="text-3xl font-bold terminal-red">0</div>
                            <div class="text-xs terminal-dim">Davy Jones</div>
                        </div>
                    </div>
                    <div id="claude-recent-work" class="scrollable-content space-y-1 text-sm">
                        <div class="terminal-dim">Loading recent work...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Services & Infrastructure Row -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
            <!-- Services Status -->
            <div class="card">
                <h2 class="text-xl font-bold mb-3 terminal-green">üîß SERVICES</h2>
                <div id="services-list" class="space-y-2"></div>
                <div class="mt-4 grid grid-cols-2 gap-2">
                    <button onclick="restartPortal()" class="btn btn-danger text-sm">
                        üîÑ Restart Portal
                    </button>
                    <button onclick="viewServiceLogs()" class="btn text-sm">
                        üìú Service Logs
                    </button>
                </div>
            </div>

            <!-- Infrastructure Health -->
            <div class="card">
                <h2 class="text-xl font-bold mb-3 terminal-green">üèóÔ∏è INFRASTRUCTURE</h2>
                <div id="infrastructure-health" class="space-y-2">
                    <div class="terminal-dim">Loading...</div>
                </div>
                <div class="mt-3">
                    <div class="font-bold text-sm mb-1">Docker Status:</div>
                    <div id="docker-health" class="text-sm space-y-1">
                        <span class="terminal-dim">Checking containers...</span>
                    </div>
                </div>
            </div>

            <!-- Security & Alerts -->
            <div class="card">
                <h2 class="text-xl font-bold mb-3 terminal-red">üîí SECURITY</h2>
                <div class="mb-3">
                    <div class="font-bold text-sm mb-1">Updates Available:</div>
                    <div id="security-updates" class="text-sm">
                        <span class="terminal-yellow">Checking...</span>
                    </div>
                </div>
                <div>
                    <div class="font-bold text-sm mb-1">Recent Alerts:</div>
                    <div id="recent-alerts" class="text-sm space-y-1">
                        <span class="terminal-dim">No alerts</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Personal Assistant & Automation Row - Full Width -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
            <!-- Personal Assistant -->
            <div class="card">
                <h2 class="text-xl font-bold mb-3 terminal-green">ü§ñ PERSONAL ASSISTANT</h2>
                <div class="grid grid-cols-3 gap-4 mb-3">
                    <div class="text-center">
                        <div class="terminal-dim text-xs">Status</div>
                        <div id="pa-status" class="font-bold">--</div>
                    </div>
                    <div class="text-center">
                        <div class="terminal-dim text-xs">Tickets</div>
                        <div id="pa-tickets" class="metric-value terminal-yellow">0</div>
                    </div>
                    <div class="text-center">
                        <div class="terminal-dim text-xs">Improvements</div>
                        <div id="pa-improvements" class="metric-value terminal-green">0</div>
                    </div>
                </div>
                <div id="pa-activity" class="scrollable-content space-y-1 text-sm">
                    <div class="terminal-dim">Loading activity...</div>
                </div>
            </div>

            <!-- Automation Status -->
            <div class="card">
                <h2 class="text-xl font-bold mb-3 terminal-green">‚öôÔ∏è AUTOMATION</h2>
                <div class="mb-3">
                    <div class="font-bold text-sm mb-2">Cron Jobs:</div>
                    <div id="cron-jobs-status" class="space-y-1 text-sm">
                        <span class="terminal-dim">Loading...</span>
                    </div>
                </div>
                <div>
                    <div class="font-bold text-sm mb-2">Recent Cron Activity:</div>
                    <div id="cron-activity" class="scrollable-content space-y-1 text-xs font-mono">
                        <span class="terminal-dim">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Git & Error Tracking Row -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
            <!-- Git Status -->
            <div class="card">
                <h2 class="text-xl font-bold mb-3 terminal-green">üì¶ GIT STATUS</h2>
                <div class="mb-3">
                    <div class="flex justify-between text-sm">
                        <span class="terminal-dim">Branch:</span>
                        <span id="git-branch" class="terminal-yellow">main</span>
                    </div>
                </div>
                <div>
                    <div class="font-bold text-sm mb-2">Recent Commits:</div>
                    <div id="recent-commits" class="scrollable-content space-y-1 text-xs">
                        <span class="terminal-dim">Loading...</span>
                    </div>
                </div>
            </div>

            <!-- Error Tracking -->
            <div class="card">
                <h2 class="text-xl font-bold mb-3 terminal-red">‚ùå ERRORS</h2>
                <div class="text-center mb-3">
                    <div class="terminal-dim text-xs">Last 24h</div>
                    <div id="error-count" class="text-3xl font-bold terminal-red">0</div>
                </div>
                <div>
                    <div class="font-bold text-sm mb-2">Recent Errors:</div>
                    <div id="recent-errors" class="scrollable-content space-y-1 text-xs">
                        <span class="terminal-dim">No errors</span>
                    </div>
                </div>
            </div>

            <!-- Files Activity -->
            <div class="card">
                <h2 class="text-xl font-bold mb-3 terminal-green">üìÅ FILE ACTIVITY</h2>
                <div id="files-activity" class="scrollable-content space-y-1 text-sm">
                    <span class="terminal-dim">Loading...</span>
                </div>
            </div>
        </div>

        <!-- Projects Overview - Full Width -->
        <div class="card mb-6">
            <h2 class="text-xl font-bold mb-3 terminal-green">üöÄ PROJECTS OVERVIEW</h2>
            <div id="projects-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
        </div>

        <!-- Logs Section - Full Width -->
        <div class="card">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-xl font-bold terminal-green">üìú RECENT LOGS</h2>
                <button onclick="clearOldLogs()" class="btn text-sm">üóëÔ∏è Clear Old Logs</button>
            </div>
            <div id="logs-list" class="scrollable-content space-y-1 text-xs font-mono">
                <div class="terminal-dim">Loading logs...</div>
            </div>
        </div>
    </div>

    <!-- Log Modal -->
    <div id="logModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle" class="text-xl font-bold mb-3 terminal-green">Log Viewer</h2>
            <div id="modalInfo" class="mb-3 text-sm terminal-yellow"></div>
            <pre id="modalContent" class="text-xs terminal-green"></pre>
        </div>
    </div>

    <script>
        // Auto-refresh every 30 seconds
        setInterval(refreshData, 30000);
        
        // Initial load
        document.addEventListener('DOMContentLoaded', function() {
            refreshData();
            updateTime();
            setInterval(updateTime, 1000);
            updateComprehensiveSections();
            setInterval(updateComprehensiveSections, 60000); // Update every minute
        });

        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleString();
        }

        async function refreshData() {
            try {
                // Update Barbossa status
                const statusResponse = await fetch('/api/status');
                if (statusResponse.ok) {
                    const status = await statusResponse.json();
                    updateBarbossaStatus(status);
                }

                // Update system stats
                const statsResponse = await fetch('/api/stats');
                if (statsResponse.ok) {
                    const stats = await statsResponse.json();
                    updateSystemStats(stats);
                }

                // Update services
                const servicesResponse = await fetch('/api/services');
                if (servicesResponse.ok) {
                    const services = await servicesResponse.json();
                    updateServices(services);
                }

                // Update logs
                const logsResponse = await fetch('/api/logs');
                if (logsResponse.ok) {
                    const logs = await logsResponse.json();
                    updateLogs(logs);
                }

                // Update projects
                const projectsResponse = await fetch('/api/projects');
                if (projectsResponse.ok) {
                    const projects = await projectsResponse.json();
                    updateProjects(projects);
                }

                // Update next runs
                const nextRunsResponse = await fetch('/api/next-runs');
                if (nextRunsResponse.ok) {
                    const nextRuns = await nextRunsResponse.json();
                    updateNextRuns(nextRuns);
                }

                // Update Barbossa executions
                const executionsResponse = await fetch('/api/barbossa/executions');
                if (executionsResponse.ok) {
                    const executions = await executionsResponse.json();
                    updateBarbossaExecutions(executions);
                }

                // Update cron activity
                const cronResponse = await fetch('/api/barbossa/cron');
                if (cronResponse.ok) {
                    const cronData = await cronResponse.json();
                    updateCronActivity(cronData);
                }

                // Update personal assistant status
                const paResponse = await fetch('/api/barbossa/personal-assistant');
                if (paResponse.ok) {
                    const paData = await paResponse.json();
                    updatePersonalAssistant(paData);
                }

                // Update Claude work summary
                const claudeResponse = await fetch('/api/barbossa/claude-summary');
                if (claudeResponse.ok) {
                    const claudeData = await claudeResponse.json();
                    updateClaudeSummary(claudeData);
                }

                document.getElementById('system-status').innerHTML = 
                    '<span class="status-online">‚óè All systems operational</span>';
            } catch (error) {
                console.error('Error refreshing data:', error);
                document.getElementById('system-status').innerHTML = 
                    '<span class="status-offline">‚óè Connection error</span>';
            }
        }

        function updateBarbossaStatus(status) {
            const statusElem = document.getElementById('barbossa-status');
            if (status.is_running) {
                statusElem.innerHTML = '<span class="status-online">‚óè RUNNING</span>';
            } else {
                statusElem.innerHTML = '<span class="status-idle">‚óè IDLE</span>';
            }
            
            document.getElementById('claude-count').textContent = status.claude_processes || 0;
            document.getElementById('last-run').textContent = status.last_run || 'Never';
            
            // Update work tally
            const tallyElem = document.getElementById('work-tally');
            if (status.work_tally) {
                let tallyHtml = '';
                for (const [area, count] of Object.entries(status.work_tally)) {
                    const percentage = ((count / status.total_runs) * 100).toFixed(1);
                    const barWidth = Math.round(percentage);
                    tallyHtml += `
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span class="terminal-dim">${area.replace('_', ' ').toUpperCase()}</span>
                                <span>${count} (${percentage}%)</span>
                            </div>
                            <div class="w-full bg-gray-800 h-2">
                                <div class="bg-green-500 h-2" style="width: ${barWidth}%"></div>
                            </div>
                        </div>
                    `;
                }
                tallyElem.innerHTML = tallyHtml;
            }
        }

        function updateSystemStats(stats) {
            document.getElementById('cpu-usage').textContent = stats.cpu + '%';
            document.getElementById('memory-usage').textContent = stats.memory + '%';
            document.getElementById('disk-usage').textContent = stats.disk + '%';
            document.getElementById('uptime').textContent = stats.uptime || '--';
            document.getElementById('network-conn').textContent = stats.network_connections || '--';
        }

        function updateServices(services) {
            const servicesElem = document.getElementById('services-list');
            let html = '';
            for (const [name, status] of Object.entries(services)) {
                const statusClass = status === 'running' ? 'status-online' : 'status-offline';
                const icon = status === 'running' ? '‚óè' : '‚óã';
                html += `
                    <div class="flex justify-between text-sm">
                        <span>${name}</span>
                        <span class="${statusClass}">${icon} ${status.toUpperCase()}</span>
                    </div>
                `;
            }
            servicesElem.innerHTML = html;
        }

        function updateLogs(logs) {
            const logsElem = document.getElementById('logs-list');
            let html = '';
            logs.forEach(log => {
                const icon = log.type === 'error' ? '‚ùå' : 
                           log.type === 'warning' ? '‚ö†Ô∏è' : 
                           log.type === 'success' ? '‚úÖ' : 'üìù';
                html += `
                    <div class="log-entry" onclick="viewLog('${log.file}')">
                        <span>${icon}</span>
                        <span class="terminal-dim">${log.time}</span>
                        <span>${log.name}</span>
                        <span class="terminal-dim">(${log.size})</span>
                    </div>
                `;
            });
            logsElem.innerHTML = html || '<div class="terminal-dim">No recent logs</div>';
        }

        function updateProjects(projects) {
            const projectsElem = document.getElementById('projects-list');
            let html = '';
            projects.forEach(project => {
                const statusClass = project.has_changes ? 'terminal-yellow' : 'terminal-green';
                const icon = project.has_changes ? '‚ö†Ô∏è' : '‚úÖ';
                html += `
                    <div class="card-compact">
                        <div class="font-bold text-sm mb-1">${project.name}</div>
                        <div class="text-xs terminal-dim">${project.path}</div>
                        <div class="text-xs ${statusClass} mt-1">
                            ${icon} ${project.has_changes ? 'Has changes' : 'Clean'}
                        </div>
                    </div>
                `;
            });
            projectsElem.innerHTML = html || '<div class="terminal-dim">No projects found</div>';
        }

        function updateNextRuns(nextRuns) {
            const nextRunsElem = document.getElementById('next-runs');
            let html = '';
            nextRuns.forEach(run => {
                html += `
                    <div class="text-xs">
                        <span class="terminal-yellow">${run.time}</span> - ${run.task}
                    </div>
                `;
            });
            nextRunsElem.innerHTML = html || '<div class="terminal-dim">No scheduled runs</div>';
        }

        function updateBarbossaExecutions(executions) {
            const elem = document.getElementById('barbossa-executions');
            if (executions && executions.length > 0) {
                let html = '';
                executions.forEach(exec => {
                    const statusIcon = exec.status === 'completed' ? '‚úÖ' : 
                                     exec.status === 'failed' ? '‚ùå' : 'üîÑ';
                    html += `
                        <div class="log-entry" onclick="viewLog('${exec.log_file}')">
                            <div class="flex justify-between">
                                <span>
                                    ${statusIcon} 
                                    <span class="terminal-yellow">${exec.timestamp}</span>
                                    <span class="terminal-dim">- ${exec.area}</span>
                                </span>
                                <span class="text-xs terminal-dim">${exec.duration || 'N/A'}</span>
                            </div>
                            ${exec.summary ? `<div class="text-xs terminal-dim ml-6">${exec.summary}</div>` : ''}
                        </div>
                    `;
                });
                elem.innerHTML = html;
            } else {
                elem.innerHTML = '<div class="terminal-dim">No recent executions</div>';
            }
        }

        function updateCronActivity(cronData) {
            const elem = document.getElementById('cron-activity');
            if (cronData && cronData.recent_logs) {
                let html = '';
                cronData.recent_logs.forEach(log => {
                    html += `
                        <div class="log-entry" onclick="viewLog('${log.file}')">
                            <span class="terminal-yellow">${log.time}</span>
                            <span class="terminal-dim">- ${log.status}</span>
                        </div>
                    `;
                });
                elem.innerHTML = html;
            } else {
                elem.innerHTML = '<div class="terminal-dim">No cron activity</div>';
            }

            // Update cron jobs status
            const cronJobsElem = document.getElementById('cron-jobs-status');
            if (cronData && cronData.jobs) {
                let jobsHtml = '';
                cronData.jobs.forEach(job => {
                    const statusClass = job.enabled ? 'terminal-green' : 'terminal-dim';
                    jobsHtml += `
                        <div class="${statusClass}">
                            ${job.enabled ? '‚úÖ' : '‚è∏Ô∏è'} ${job.name} - ${job.schedule}
                        </div>
                    `;
                });
                cronJobsElem.innerHTML = jobsHtml;
            }
        }

        function updatePersonalAssistant(paData) {
            if (paData) {
                document.getElementById('pa-status').innerHTML = 
                    paData.is_running ? '<span class="status-online">‚óè ACTIVE</span>' : 
                                      '<span class="status-idle">‚óè IDLE</span>';
                document.getElementById('pa-tickets').textContent = paData.tickets_enriched || 0;
                document.getElementById('pa-improvements').textContent = paData.improvements_found || 0;
                
                const activityElem = document.getElementById('pa-activity');
                if (paData.recent_activity && paData.recent_activity.length > 0) {
                    let html = '';
                    paData.recent_activity.forEach(activity => {
                        html += `
                            <div class="text-xs">
                                <span class="terminal-yellow">${activity.time}</span>
                                <span class="terminal-dim">-</span>
                                <span>${activity.action}</span>
                            </div>
                        `;
                    });
                    activityElem.innerHTML = html;
                } else {
                    activityElem.innerHTML = '<div class="terminal-dim">No recent activity</div>';
                }
            }
        }

        function updateClaudeSummary(claudeData) {
            if (claudeData) {
                document.getElementById('claude-personal').textContent = claudeData.personal_projects || 0;
                document.getElementById('claude-infrastructure').textContent = claudeData.infrastructure || 0;
                document.getElementById('claude-davy').textContent = claudeData.davy_jones || 0;
                
                // Update recent work if available
                const recentWorkElem = document.getElementById('claude-recent-work');
                if (claudeData.recent_work && claudeData.recent_work.length > 0) {
                    let html = '';
                    claudeData.recent_work.forEach(work => {
                        html += `
                            <div class="text-xs">
                                <span class="terminal-yellow">${work.time}</span>
                                <span class="terminal-dim">-</span>
                                <span>${work.task}</span>
                            </div>
                        `;
                    });
                    recentWorkElem.innerHTML = html;
                }
            }
        }

        async function updateComprehensiveSections() {
            try {
                // Update security updates
                const securityResponse = await fetch('/api/security/updates');
                if (securityResponse.ok) {
                    const data = await securityResponse.json();
                    const elem = document.getElementById('security-updates');
                    if (data.updates_available > 0) {
                        elem.innerHTML = `<span class="terminal-red">‚ö†Ô∏è ${data.updates_available} updates available</span>`;
                    } else {
                        elem.innerHTML = '<span class="terminal-green">‚úÖ System up to date</span>';
                    }
                    
                    // Update alerts
                    const alertsElem = document.getElementById('recent-alerts');
                    if (data.recent_alerts && data.recent_alerts.length > 0) {
                        let html = '';
                        data.recent_alerts.forEach(alert => {
                            html += `<div class="text-xs terminal-yellow">${alert}</div>`;
                        });
                        alertsElem.innerHTML = html;
                    } else {
                        alertsElem.innerHTML = '<span class="terminal-dim">No recent alerts</span>';
                    }
                }

                // Update errors
                const errorsResponse = await fetch('/api/errors/recent');
                if (errorsResponse.ok) {
                    const data = await errorsResponse.json();
                    document.getElementById('error-count').textContent = data.error_count || 0;
                    
                    const errorsElem = document.getElementById('recent-errors');
                    if (data.recent_errors && data.recent_errors.length > 0) {
                        let html = '';
                        data.recent_errors.forEach(error => {
                            html += `
                                <div class="text-xs">
                                    <span class="terminal-red">${error.time}</span>
                                    <span>- ${error.message}</span>
                                </div>
                            `;
                        });
                        errorsElem.innerHTML = html;
                    } else {
                        errorsElem.innerHTML = '<span class="terminal-dim">No recent errors</span>';
                    }
                }

                // Update git status
                const gitResponse = await fetch('/api/git/status');
                if (gitResponse.ok) {
                    const data = await gitResponse.json();
                    document.getElementById('git-branch').textContent = data.branch || 'main';
                    
                    const commitsElem = document.getElementById('recent-commits');
                    if (data.recent_commits && data.recent_commits.length > 0) {
                        let html = '';
                        data.recent_commits.forEach(commit => {
                            html += `
                                <div class="text-xs">
                                    <span class="terminal-yellow">${commit.hash}</span>
                                    <span>- ${commit.message}</span>
                                </div>
                            `;
                        });
                        commitsElem.innerHTML = html;
                    }
                }

                // Update infrastructure health
                const infraResponse = await fetch('/api/infrastructure/health');
                if (infraResponse.ok) {
                    const data = await infraResponse.json();
                    const healthElem = document.getElementById('infrastructure-health');
                    let html = '';
                    Object.entries(data.services || {}).forEach(([service, status]) => {
                        const statusClass = status === 'healthy' ? 'terminal-green' : 'terminal-red';
                        html += `
                            <div class="flex justify-between text-sm">
                                <span>${service}</span>
                                <span class="${statusClass}">${status}</span>
                            </div>
                        `;
                    });
                    healthElem.innerHTML = html || '<span class="terminal-dim">No data</span>';
                    
                    // Update Docker health
                    const dockerElem = document.getElementById('docker-health');
                    if (data.docker_containers) {
                        let dockerHtml = '';
                        data.docker_containers.forEach(container => {
                            const statusClass = container.status === 'running' ? 'terminal-green' : 'terminal-yellow';
                            dockerHtml += `<div class="${statusClass}">‚óè ${container.name}</div>`;
                        });
                        dockerElem.innerHTML = dockerHtml || '<span class="terminal-dim">No containers</span>';
                    }
                }

                // Update files activity
                const filesResponse = await fetch('/api/files/activity');
                if (filesResponse.ok) {
                    const data = await filesResponse.json();
                    const filesElem = document.getElementById('files-activity');
                    if (data.recent_changes && data.recent_changes.length > 0) {
                        let html = '';
                        data.recent_changes.forEach(change => {
                            const icon = change.type === 'added' ? '‚ûï' : 
                                       change.type === 'modified' ? 'üìù' : 'üóëÔ∏è';
                            html += `
                                <div class="text-xs">
                                    ${icon} ${change.file}
                                    <span class="terminal-dim">- ${change.time}</span>
                                </div>
                            `;
                        });
                        filesElem.innerHTML = html;
                    } else {
                        filesElem.innerHTML = '<span class="terminal-dim">No recent file activity</span>';
                    }
                }

                // Update automation status
                const automationResponse = await fetch('/api/automation/status');
                if (automationResponse.ok) {
                    const data = await automationResponse.json();
                    // This is handled in updateCronActivity
                }

            } catch (error) {
                console.error('Error updating comprehensive sections:', error);
            }
        }

        async function viewLog(filename) {
            try {
                const response = await fetch(`/api/log/${encodeURIComponent(filename)}`);
                if (response.ok) {
                    const data = await response.json();
                    showLogModal(filename, data.content, data.size);
                } else {
                    alert('Error loading log file');
                }
            } catch (error) {
                alert('Error loading log: ' + error.message);
            }
        }

        function showLogModal(filename, content, size) {
            document.getElementById('modalTitle').textContent = `Log Viewer: ${filename}`;
            document.getElementById('modalInfo').textContent = `Size: ${size} | Lines: ${content.split('\n').length}`;
            document.getElementById('modalContent').textContent = content;
            document.getElementById('logModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('logModal').style.display = 'none';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('logModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        async function triggerBarbossa(area) {
            if (!confirm(`Run Barbossa for ${area}?`)) return;
            
            try {
                const response = await fetch('/api/trigger-barbossa', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({area: area})
                });
                
                if (response.ok) {
                    alert('Barbossa triggered successfully');
                    setTimeout(refreshData, 2000);
                } else {
                    alert('Failed to trigger Barbossa');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function restartPortal() {
            if (!confirm('Restart the web portal? You will be disconnected.')) return;
            
            try {
                await fetch('/api/restart', {method: 'POST'});
                alert('Portal restarting... Please wait 10 seconds and refresh.');
            } catch (error) {
                // Expected to fail as server restarts
            }
        }

        async function clearOldLogs() {
            if (!confirm('Clear logs older than 7 days?')) return;
            
            try {
                const response = await fetch('/api/clear-old-logs', {method: 'POST'});
                if (response.ok) {
                    const result = await response.json();
                    alert(`Cleared ${result.cleared} old log files`);
                    refreshData();
                }
            } catch (error) {
                alert('Error clearing logs: ' + error.message);
            }
        }

        function viewLogs() {
            window.location.href = '/logs';
        }

        function viewServiceLogs() {
            // Could open a modal or navigate to specific service logs
            alert('Service logs viewer coming soon');
        }

        function viewCronSchedule() {
            // Could open a modal showing full cron schedule
            alert('Cron schedule viewer coming soon');
        }
    </script>
</body>
</html>